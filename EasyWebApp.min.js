!function(){"function"==typeof this.define&&this.define.amd?this.define("EasyWebApp",["iQuery+"],arguments[0]):arguments[0]()}(function(){var t;t=function(t,e,i){function a(t,e){i.ListView(this,function(){e.call(arguments[0],arguments[1])}).clear().render(t)}function n(t){var e=arguments.callee;if(t instanceof Array)return a.call(this[0],t,e);var n=i.CommonView.getInstance(this);return n?n.render(t):void this.value("name",function(n){if(t[n]instanceof Array)a.call(this,t[n],e);else{if(!i.isPlainObject(t[n]))return t[n];e.call(i(this),t[n])}})}i.fn.extend({dataRender:function(t){return t instanceof Array?a.call(i.ListView.findView(this,!0)[0],t,n):n.call(this,t),this},dataReader:function(){var t=i("[name]",this[0]).not(i("[name] [name]",this[0])),e={};if(!t[0])return this.value();for(var a,n,r=0;r<t.length;r++)if(a=t[r].getAttribute("name"),n=i.ListView.getInstance(t[r])){e[a]=[];for(var s=0;s<n.length;s++)e[a][s]=i.extend(n.valueOf(s),arguments.callee.call(n[s]))}else e[a]=arguments.callee.call(i(t[r]));return e}})}(self,self.document,self.jQuery),t=function(t,e,i){function a(t,e,a,n){this.ownApp=t,this.$_DOM=i.isPlainObject(e)?this.createDOM(e,a,n):i(e);var r=arguments.callee,s=this.$_DOM.data("EWA_PageLink");if(s instanceof r)return s;switch(this.$_DOM.data("EWA_PageLink",this).css("cursor","pointer"),i.extend(this,r.getAttr(this.$_DOM)),this.target){case"_top":this.type="Outer";break;case"_blank":this.type="Data";break;case"_self":default:this.href&&(this.type="Inner")}this.method=(this.method||"Get").toLowerCase(),this.data={},this.href=this.href||this.ownApp.history.last().HTML,this.href=this.getURL("href");var o=i.fileName(this.href).split(".");i.extend(this.data,{_File_Path_:i.filePath(this.href),_File_Name_:o[0],_Ext_Name_:o[1]}),this.src&&i.extend(this.data,{_Data_Path_:i.filePath(this.src),_Data_Name_:i.fileName(this.src)}),(this.href||"").indexOf("?")>-1&&(this.data=i.extend(i.paramJSON(this.href),this.data))}function n(a,n){i.extend(this,{ownerApp:a,sourceLink:n,title:n.title||e.title,URL:n.alt||t.location.href,HTML:n.href||e.URL,method:n.method,JSON:n.src||n.action,time:i.now(),innerLink:[],innerTemplate:[]})}function r(){var e=i.extend(this,{length:0,ownerApp:arguments[0],root:arguments[1],lastIndex:-1});d.on("popstate",function(){var i=arguments[0].state,a=(i||{}).DOM_Index,n=e[a];return n?(e.move(i),n.show().onReady(),e.prevIndex=e.lastIndex,void(e.lastIndex=i.DOM_Index)):t.history.go(e[a-1]?-1:1)})}function s(t,e){var a=i.makeArray(arguments);return a.unshift(!0),a.slice(-1)[0]instanceof Array&&a.splice(1,0,[]),i.extend.apply(i,a)}function o(t,e,a,n){i.Observer.apply(this),i.extend(this,{domRoot:i(t),apiRoot:e||"",cache:a||0==a?a:1/0,urlChange:n,history:new r(this,t),loading:!1})}function h(){var t=this.history.last();return this.trigger(arguments[0],t.HTML,t.JSON,arguments[1]).slice(-1)[0]}function l(){return i.inArray("nofollow",(this.getAttribute("rel")||"").split(/\s+/))>-1}function c(){var t=this.tagName.toLowerCase(),e=arguments.callee.caller.arguments[0];switch(e.type){case"click":case"tap":if("a"==t){if(l.call(this))return!0;e.preventDefault()}return t in g;case"change":return this!==e.target}}function f(){var e=i.split(t.location.hash,"!",2);if("#"==e[0]&&e[1]){this.findLink();var a=i('*[target="_self"][href="'+e[1]+'"]');return a[0]?a[0]["form"!=a[0].tagName.toLowerCase()?"click":"submit"]():this.ownerApp.loadLink(e[1]),e[1]}}a.getAttr=function(){return arguments[0].attr(["target","title","alt","href","method","src","action"])};var p=i.browser.modern?"prefetch":"next";a.prefetchClear=function(){i('head link[rel="'+p+'"]').remove()},i.extend(a.prototype,{createDOM:function(t,a,n){var r={};if(i.isPlainObject(a))for(var s in a)r["data-"+s]=a[s];var o=i("<button />",i.extend({rel:"nofollow",css:{display:"none"}},t,r)).appendTo(e.body);return(n instanceof Array||i.isPlainObject(n))&&o.data("EWA_Model",n),o},getData:function(){var t=this.$_DOM.data("EWA_Model");if(!t){var e=this.$_DOM.hasClass("ListView_Item")?this.$_DOM:this.$_DOM.parents(".ListView_Item");e[0]&&(t=i.ListView.getInstance(e[0].parentNode).valueOf(e))}return this.data=i.extend(t||{},this.data)},getArgs:function(){var t=i.extend(this.ownApp.history.getData(),this.getData());return i.map(this.$_DOM[0].dataset,function(e){return Number(e)%1!==0&&void 0!==t[e]?t[e]:e})},getURL:function(t){return this[t]?("href"==t&&"#"==this[t][0]||(this[t]=this.ownApp.makeURL(this[t]||"",this.getData(),("href"==t?!this.src:"GET"==this.method.toUpperCase())&&this.getArgs()),"href"==t&&"?"==this[t].slice(-1)&&(this[t]=this[t].slice(0,-1))),this[t]):""},valueOf:function(){var t={};for(var e in this)(typeof this[e]).match(/object|function/)||(t[e]=this[e]);return t}}),i.extend(n.prototype,{show:function(e){e=e?i(e):this.$_Page;var n=this.ownerApp.history,r=n.isForward(this);if(!e)return"Inner"!=this.sourceLink.type?t.setTimeout(function(){t.history[r?"forward":"back"]()}):(this.sourceLink=new a(this.ownerApp,this.sourceLink.valueOf()),this.sourceLink.$_DOM[0].click()),this;var s=this.sourceLink.getTarget();if((n.length||r)&&n.move(s),this.$_Page=e.appendTo(s).fadeIn(),!arguments.length){var o=n.last(!0).sourceLink.$_DOM[0],h=i.ListView.getInstance(o.parentElement);h?h.focus(o):o.scrollIntoView()}return this},valueOf:a.prototype.valueOf});var d=i(t);i.extend(r.prototype,{splice:Array.prototype.splice,push:Array.prototype.push,slice:Array.prototype.slice,indexOf:Array.prototype.indexOf,move:function(){if(i.isPlainObject(arguments[0]))var t=arguments[0];else{var e=arguments[0];i.ListView.findView(this.root,!0)}var a=(e||this.root).children().detach();return t&&t.DOM_Index+2!=this.length||(this[this.length-1].$_Page=this[this.length-1].$_Page||a),a},write:function(){this.prevIndex=this.lastIndex++,this.splice(this.lastIndex,this.length);var e=new n(this.ownerApp,arguments[0]||{});return this.push(e),e.$_Page=(this.cache()||{}).$_Page,t.history.pushState({DOM_Index:this.lastIndex},e.title,e.URL),e},cache:function(){for(var t=this[this.lastIndex],e=0;e<this.lastIndex;e++)if(t.time-this[e].time>1e3*this.ownerApp.cache)this[e].sourceLink.action||(this[e].$_Page=null);else if(!t.JSON&&i.isEqual(t.sourceLink,this[e].sourceLink))return this[e]},last:function(){var t=this[this.lastIndex]||{};return arguments[0]?t:t.valueOf()},prev:function(){var t=this[this.prevIndex]||{};return arguments[0]?t:t.valueOf()},isForward:function(){return this.indexOf(arguments[0])>this.indexOf(this.last(!0))},mergeData:function(t,e){var a=this.slice(e,e+1||void 0)[0];return a.data=i.extend(a.data||{},t instanceof i?i.paramJSON("?"+t.serialize()):t),t},getData:function(){var t=i.map(this,function(t){var e=t.data||t.sourceLink.data;return e&&[e]});return t.length<2?t[0]||{}:s.apply(null,t)}}),o.prototype=new i.Observer,o.prototype.constructor=o;var u=/\{(.+?)\}/g;o.prototype.makeURL=function(e,a,n){e=i.split(e,"?",2),a=i.extend(this.history.getData(),a||{});var r=("&"+e[1]).match(/&([^=]+)=\?/);r=r&&r[1];var s=i.param(i.extend(n||{},i.paramJSON("?"+e[1].replace(r+"=?",""))));return e=[t.decodeURIComponent(e[0]).replace(u,function(){return a[arguments[1]]}),r?[s,s?"&":"",r,"=?"].join(""):s].join("?"),e.match(/^(\w+:)?\/\/[\w\d]+/)||i.fileName(e).match(/\.(htm|html|md|markdown)$/)||(e=this.apiRoot+e),e},i.extend(a.prototype,{getTarget:function(){return this.target.match(/^_(self|blank)$/)?this.ownApp.domRoot:i('[name="'+this.target+'"]')},prefetch:function(){var t=(this.href||"").split("?");if("_self"==this.target&&-1==(t[1]||"").indexOf("=")){var a=i("<link />",{rel:p,href:this.href});this.method.match(/Get/i)&&this.src&&!this.src.match(u)&&i.isEmptyObject(this.$_DOM[0].dataset)&&a.add(i("<link />",{rel:p,href:this.getURL("src")})),a.appendTo(e.head)}return this},loadData:function(t){function e(e){e=h.call(r,"apiCall",[{method:n.method,URL:s||n.getURL("action"),data:e},r.history.last().HTML,r])||e,"function"==typeof t?t.call(n,e):r.history.mergeData(e,-1)}var a=i(this.$_DOM).parents("form").eq(0);a.length&&this.ownApp.history.mergeData(a,-1);var n=this,r=this.ownApp,s=this.getURL("src");if(!s)return e.call(this,this.getData());switch(this.method){case"get":i[this.method](s,e);break;case"post":case"put":case"delete":i[this.method](s,this.getArgs(),e)}}}),i.extend(n.prototype,{boot:function(t){function e(e){h=s(h,e),--l>0||(t.call(n,h),o.remove())}var n=this,r=i("head link[target][href]"),o=i("head link[src]");if(r.length&&this.ownerApp.one("pageReady",function(){return arguments[2].loadLink(r.remove().attr(["target","href"]),null,n.sourceLink.getData())}),!o.length)return t.call(this);for(var h={},l=o.length,c=0;c<o.length;c++)new a(this.ownerApp,o[c]).loadData(e)},getTemplate:function(t){return this.innerTemplate[t]||(this.innerTemplate[t]=i('*[id="'+t+'"]').remove(),i.ListView.findView(this.innerTemplate[t],!1)),this.innerTemplate[t].children().clone(!0)},load:function(a,n){var r=/\.(md|markdown)\??/i,s=this,o=this.ownerApp;return"#"==a.href[0]?n.call(this.show(this.getTemplate(a.href.slice(1))).ownerApp):void i.get(a.href,a.href.match(r)?function(e){e=(arguments[2]||"").responseText||e,"function"==typeof t.marked?s.show(t.marked(e)).$_Page.find("a[href]").attr("target",function(){return this.href.indexOf("#!")||l.call(this)?this.href.match(r)?"_self":"_top":(this.setAttribute("rel","nofollow"),arguments[1])}):o.domRoot.text(e),n.call(o)}:function(t){if(t=(arguments[2]||"").responseText||t,!t.match(/<\s*(html|head|body)(\s|>)/i)&&!t.match(/<\s*(link|script)(\s|>)/i))return s.show(t).boot(n);for(var a=i(t.children||t),r=[],o=0,h=0;a[o];o++)switch(a[o].tagName.toLowerCase()){case"link":("stylesheet"==a[o].rel||a[o].getAttribute("target"))&&e.head.appendChild(a[o]);break;case"script":a[o].text.trim()&&i.globalEval(a[o].text);break;default:r[h++]=a[o]}s.show(r).boot(n)})}}),i.extend(a.prototype,{loadTemplate:function(){function t(){arguments[0]&&(a=arguments[0]),0==--r&&i.render(s,a).onReady()}var e=h.call(this.ownApp,"pageLoad",[this.ownApp.history.last(),this.ownApp.history.prev()]);if(e!==!1){this.ownApp.loading=!0;var i=this.ownApp.history.write(this);if(this.ownApp.cache&&i.$_Page)return i.show().onReady();var a,n="Inner"==this.type,r=n?2:1,s=this;this.loadData(t),n&&i.load(this,t)}},loadPage:function(){var e=h.call(this.ownApp,"appExit",[this.ownApp.history.last().HTML,this.href,this.getData()]);e!==!1&&(this.ownApp.history.move(),t.sessionStorage.EWA_Model=t.JSON.stringify(i.isPlainObject(e)?e:this.getData()),t.location.href=this.href+"?"+i.param(this.getArgs()))}}),i.extend(n.prototype,{render:function(t,a){var n=this.ownerApp;a=s(t&&t.getData(),a);var r=h.call(n,"pageRender",[n.history.last(),n.history.prev(),a]);if(this.data=a=r||a,r!==!1){var o=n.domRoot;a instanceof Array?t&&"_self"!=t.target&&(o=t.getTarget().parent()):o=i(e.body),o.dataRender(a)}return this},findLink:function(t){for(var n,r=this.ownerApp.history.lastIndex?this.ownerApp.domRoot:i(e.body),s=r.find("*[target]").not(i.ListView.findView(r).find("*[target]")),o=0;o<s.length;o++)n=new a(this.ownerApp,s[o]),this.innerLink.push(n),t&&n.prefetch();return s},onReady:function(){i("button[target]:hidden",e.body).remove();var t=this.ownerApp;return a.prefetchClear(),t.loading=!1,h.call(t,"pageReady",[t.history.last(),t.history.prev(),t]),this.findLink(!0),t.domRoot.focus(),i(e.body).trigger({type:"loading",detail:1}),this}});var g=i.makeSet("form","input","textarea","select");return i(e).ready(function(){i(this.body).on((i.browser.mobile?"tap":"click")+" change","*[target]",function(){if(!c.call(this)){var t=new a(i(".EWA_Container").WebApp(),this);switch(t.target){case"_self":t.href&&t.loadTemplate();break;case"_blank":t.src&&t.loadData();break;case"_top":t.href&&t.loadPage();break;default:t.loadTemplate()}}})}),o.prototype.loadLink=function(t,e,i){return"string"==typeof t&&(t={target:"_self",href:t,src:e},e=i,i=arguments[3]),this.loading=!1,(t instanceof a?t:new a(this,t,e,i)).$_DOM.click(),this},o.prototype.boot=function(){if(this.history.length)throw"This WebApp has been booted !";this.loading=!0;var t=new a(this,{target:""},null,arguments[0]),n=this.history.write(t,t.getTarget()),r=this;return i(e.body).on("submit","form:visible",function(){if(r.loading)return!1;var t=i(this).data("EWA_PageLink")||new a(r,this);r.history.mergeData(t.$_DOM,-1).attr("action",t.getURL("action"))}).ajaxSubmit(function(t){var e=h.call(r,"formSubmit",[r.history.last().HTML,arguments[2].url,t,i(this).attr("href")]);e!==!1&&this.target&&r.loadLink(i.extend(a.getAttr(i(this)),{action:arguments[2].url}),null,e||t)}),f.call(n)||n.boot(function(){this.render(null,arguments[0]).onReady()}),d.on("hashchange",i.proxy(f,n)),this},o}(self,self.document,self.jQuery),t=function(t,e,i,a){i.fn.WebApp=function(){if(this[0]){var e=i(this[0]).data("_EWAI_");if(e instanceof a)return e;var n=i.makeArray(arguments),r=i.extend(i.parseJSON(t.sessionStorage.EWA_Model||"{ }"),i.paramJSON(),i.isPlainObject(n[0])&&n.shift()),s="string"==typeof n[0]&&n.shift(),o="number"==typeof n[0]&&n.shift(),h="boolean"==typeof n[0]&&n[0];return e=new a(this,s,o,h).boot(r),i(this[0]).data("_EWAI_",e).addClass("EWA_Container"),e}}}(self,self.document,self.jQuery,t)});
//# sourceMappingURL=EasyWebApp.min.map