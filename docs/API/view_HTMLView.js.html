<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>view/HTMLView.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DataScope.html">DataScope</a></li><li><a href="HTMLView.html">HTMLView</a><ul class='methods'><li data-type='method'><a href="HTMLView.html#attach">attach</a></li><li data-type='method'><a href="HTMLView.html#childOf">childOf</a></li><li data-type='method'><a href="HTMLView.html#detach">detach</a></li><li data-type='method'><a href="HTMLView.html#emit">emit</a></li><li data-type='method'><a href="HTMLView.html#off">off</a></li><li data-type='method'><a href="HTMLView.html#on">on</a></li><li data-type='method'><a href="HTMLView.html#one">one</a></li><li data-type='method'><a href="HTMLView.html#parse">parse</a></li><li data-type='method'><a href="HTMLView.html#render">render</a></li><li data-type='method'><a href="HTMLView.html#scan">scan</a></li><li data-type='method'><a href="HTMLView.html#valueOf">valueOf</a></li><li data-type='method'><a href="HTMLView.html#watch">watch</a></li></ul></li><li><a href="InnerLink.html">InnerLink</a><ul class='methods'><li data-type='method'><a href="InnerLink.html#emit">emit</a></li><li data-type='method'><a href="InnerLink.html#off">off</a></li><li data-type='method'><a href="InnerLink.html#on">on</a></li><li data-type='method'><a href="InnerLink.html#one">one</a></li><li data-type='method'><a href="InnerLink.html#toString">toString</a></li><li data-type='method'><a href="InnerLink.html#valueOf">valueOf</a></li></ul></li><li><a href="ListView.html">ListView</a><ul class='methods'><li data-type='method'><a href="ListView.html#attach">attach</a></li><li data-type='method'><a href="ListView.html#childOf">childOf</a></li><li data-type='method'><a href="ListView.html#clear">clear</a></li><li data-type='method'><a href="ListView.html#detach">detach</a></li><li data-type='method'><a href="ListView.html#emit">emit</a></li><li data-type='method'><a href="ListView.html#indexOf">indexOf</a></li><li data-type='method'><a href="ListView.html#insert">insert</a></li><li data-type='method'><a href="ListView.html#off">off</a></li><li data-type='method'><a href="ListView.html#on">on</a></li><li data-type='method'><a href="ListView.html#one">one</a></li><li data-type='method'><a href="ListView.html#remove">remove</a></li><li data-type='method'><a href="ListView.html#render">render</a></li><li data-type='method'><a href="ListView.html#scan">scan</a></li><li data-type='method'><a href="ListView.html#sort">sort</a></li><li data-type='method'><a href="ListView.html#valueOf">valueOf</a></li><li data-type='method'><a href="ListView.html#watch">watch</a></li></ul></li><li><a href="Observer.html">Observer</a><ul class='methods'><li data-type='method'><a href="Observer.html#.extend">extend</a></li><li data-type='method'><a href="Observer.html#.instanceOf">instanceOf</a></li><li data-type='method'><a href="Observer.html#.registerEvent">registerEvent</a></li><li data-type='method'><a href="Observer.html#emit">emit</a></li><li data-type='method'><a href="Observer.html#off">off</a></li><li data-type='method'><a href="Observer.html#on">on</a></li><li data-type='method'><a href="Observer.html#one">one</a></li><li data-type='method'><a href="Observer.html#valueOf">valueOf</a></li></ul></li><li><a href="RenderNode.html">RenderNode</a><ul class='methods'><li data-type='method'><a href="RenderNode.html#toString">toString</a></li></ul></li><li><a href="TreeView.html">TreeView</a><ul class='methods'><li data-type='method'><a href="TreeView.html#.fromFlat">fromFlat</a></li><li data-type='method'><a href="TreeView.html#attach">attach</a></li><li data-type='method'><a href="TreeView.html#childOf">childOf</a></li><li data-type='method'><a href="TreeView.html#clear">clear</a></li><li data-type='method'><a href="TreeView.html#detach">detach</a></li><li data-type='method'><a href="TreeView.html#emit">emit</a></li><li data-type='method'><a href="TreeView.html#indexOf">indexOf</a></li><li data-type='method'><a href="TreeView.html#insert">insert</a></li><li data-type='method'><a href="TreeView.html#off">off</a></li><li data-type='method'><a href="TreeView.html#on">on</a></li><li data-type='method'><a href="TreeView.html#one">one</a></li><li data-type='method'><a href="TreeView.html#remove">remove</a></li><li data-type='method'><a href="TreeView.html#render">render</a></li><li data-type='method'><a href="TreeView.html#scan">scan</a></li><li data-type='method'><a href="TreeView.html#sort">sort</a></li><li data-type='method'><a href="TreeView.html#valueOf">valueOf</a></li><li data-type='method'><a href="TreeView.html#watch">watch</a></li></ul></li><li><a href="View.html">View</a><ul class='methods'><li data-type='method'><a href="View.html#.extend">extend</a></li><li data-type='method'><a href="View.html#attach">attach</a></li><li data-type='method'><a href="View.html#childOf">childOf</a></li><li data-type='method'><a href="View.html#detach">detach</a></li><li data-type='method'><a href="View.html#emit">emit</a></li><li data-type='method'><a href="View.html#off">off</a></li><li data-type='method'><a href="View.html#on">on</a></li><li data-type='method'><a href="View.html#one">one</a></li><li data-type='method'><a href="View.html#scan">scan</a></li><li data-type='method'><a href="View.html#valueOf">valueOf</a></li><li data-type='method'><a href="View.html#watch">watch</a></li></ul></li><li><a href="WebApp.html">WebApp</a><ul class='methods'><li data-type='method'><a href="WebApp.html#.component">component</a></li><li data-type='method'><a href="WebApp.html#emit">emit</a></li><li data-type='method'><a href="WebApp.html#getRoute">getRoute</a></li><li data-type='method'><a href="WebApp.html#load">load</a></li><li data-type='method'><a href="WebApp.html#loadPage">loadPage</a></li><li data-type='method'><a href="WebApp.html#off">off</a></li><li data-type='method'><a href="WebApp.html#on">on</a></li><li data-type='method'><a href="WebApp.html#one">one</a></li><li data-type='method'><a href="WebApp.html#setURLData">setURLData</a></li><li data-type='method'><a href="WebApp.html#valueOf">valueOf</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-WebApp.html">WebApp</a></li></ul><h3>Externals</h3><ul><li><a href="external-_jQuery.fn_.html">jQuery.fn</a><ul class='methods'><li data-type='method'><a href="external-_jQuery.fn_.html#.iWebApp">iWebApp</a></li><li data-type='method'><a href="external-_jQuery.fn_.html#.view">view</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="HTMLView.html#event:attach">attach</a></li><li><a href="HTMLView.html#event:update">update</a></li><li><a href="ListView.html#event:attach">attach</a></li><li><a href="ListView.html#event:update">update</a></li><li><a href="TreeView.html#event:attach">attach</a></li><li><a href="TreeView.html#event:update">update</a></li><li><a href="View.html#event:attach">attach</a></li><li><a href="View.html#event:update">update</a></li><li><a href="WebApp.html#event:data">data</a></li><li><a href="WebApp.html#event:ready">ready</a></li><li><a href="WebApp.html#event:request">request</a></li><li><a href="WebApp.html#event:route">route</a></li><li><a href="WebApp.html#event:template">template</a></li></ul><h3>Global</h3><ul><li><a href="global.html#require">require</a></li></ul>
</nav>

<div id="main">

    <h1 class="page-title">view/HTMLView.js</h1>

    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define([
    'jquery', './View', './DOMkit', './RenderNode'
],  function ($, View, DOMkit, RenderNode) {

    /**
     * 普通视图类（对应 JSON 对象）
     *
     * @author  TechQuery
     *
     * @class   HTMLView
     * @extends View
     *
     * @param   {jQueryAcceptable} $_View  - Container DOM of HTMLView
     * @param   {object}           [scope] - Data object as a scope
     * @param   {(string|URL)}     [base]
     *
     * @returns {HTMLView}             Return the last one if a HTMLView instance
     *                                 has been created on this element
     */

    function HTMLView($_View, scope, base) {

        var _This_ = View.call(this, $_View, scope, base);
        /**
         * 本视图的插卡元素
         *
         * @name $_Slot
         * @type {jQuery}
         *
         * @memberof HTMLView
         * @instance
         *
         * @readonly
         */
        this.$_Slot = $();

        return  (_This_ !== this)  ?
            _This_ :
            this.setPrivate( {length: 0,  map: { }} );
    }

    View.extend(HTMLView, {
        is:             function () {

            return  (! $.expr[':'].list( arguments[0] ));
        },
        rawSelector:    $.makeSet('code', 'xmp', 'template'),
        getValue:       function (field) {

            if (field.type !== 'checkbox')
                return  $( field )[('value' in field) ? 'val' : 'html']();

            field = field.form.elements[ field.name ];

            return  $.likeArray( field )  ?
                $.map(field,  function (_This_) {

                    return  _This_.checked ? _This_.value : null;
                })  :  (
                    field.checked ? field.value : ''
                );
        }
    }, {
        indexOf:       Array.prototype.indexOf,
        signIn:        function (iNode) {

            for (var i = 0;  this[i];  i++)  if (this[i] == iNode)  return;

            this[this.length++] = iNode;

            var iName = (iNode instanceof RenderNode)  ?
                    iNode  :  [iNode.__name__];

            for (var j = 0;  iName[j];  j++)
                this.watch( iName[j] ).__map__[iName[j]] =
                    (this.__map__[iName[j]] || 0)  +  Math.pow(2, i);
        },
        parsePlain:    function (node) {

            if (! (node.nodeValue || node.value))  return;

            var render = new RenderNode( node );

            if (! render.type)  return;

            this.signIn( render );

            if (node.nodeType === 8) {

                render.ownerNode = node =
                    document.createTextNode( node.nodeValue );

                render.name = node.nodeName;
            }

            return node;
        },
        parseNode:     function (type, node) {

            if ((node instanceof View)  &amp;&amp;  (this.indexOf( node )  &lt;  0))
                return  this.signIn( node );

            switch ($.Type( node )) {
                case 'Text':           ;
                case 'Comment':
                    return  this.parsePlain( node );
                case 'HTMLElement':
                    if (type in HTMLView.rawSelector)
                        return null;
                    else
                        Array.from(
                            $.makeArray( node.attributes ),
                            this.parsePlain,
                            this
                        );
            }
        },
        fixLink:       function () {

            if (! this.__base__)  return;

            var $_Link = this.$_View.find('*');

            if (! this.$_View[0].parentElement)  $_Link = $_Link.addBack();

            $_Link.filter(
                'a, area, link, form, img, iframe, audio, video, script, [data-href]'
            ).not('head > *').each(
                $.proxy(DOMkit.fixURL, null, this.__base__)
            );
        },
        parseSlot:     function () {

            var _this_ = this, $_Slot = $();

            this.$_View.find('slot').replaceWith(function () {

                var slot = this.getAttribute('name');

                slot = _this_.$_Slot.filter(
                    slot  ?
                        ('[slot="' + slot + '"]')  :
                        function () {
                            return  this.getAttribute &amp;&amp;
                                (! this.getAttribute('slot'));
                        }
                );

                return  slot[0]  ?
                    ($_Slot.add( slot )  &amp;&amp;  slot)  :  $( this ).contents();
            });

            this.$_Slot = $_Slot;
        },
        parseVM:       function () {

            return  this.scan(function (node) {

                var $_View = this.$_View,
                    type = (node.nodeName || '').toLowerCase();

                if ((node instanceof Node)  &amp;&amp;  (node !== $_View[0]))
                    switch ( type ) {
                        case 'style':     return  DOMkit.fixStyle($_View, node);
                        case 'link':      {

                            node.onload = function () {

                                $( this ).replaceWith(
                                    DOMkit.fixStyle($_View, this)
                                );
                            };
                            return;
                        }
                        case 'script':    return  DOMkit.fixScript( node );
                    }

                return  this.parseNode(type, node);
            });
        },
        /**
         * HTML 模板解析
         *
         * @author   TechQuery
         *
         * @memberof HTMLView.prototype
         *
         * @param    {string}   [template] - A HTML String of the Component's template
         *                                   with HTMLSlotElement
         * @returns  {HTMLView} Current HTMLView
         */
        parse:         function (template) {

            if (this.__parse__)  return this;

        //  Compatible with &lt;template />

            this.$_View.children('template').replaceWith(function () {

                return  $( this ).contents();
            });

        //  Literal Relative URL &amp; &lt;slot />

            if (template = (template || '').trim()) {

                if ( this.$_View[0].innerHTML.trim() ) {

                    this.$_Slot = this.$_View.contents().remove();

                    this.$_View[0].innerHTML = template;

                    this.fixLink();

                    this.parseSlot();
                } else {
                    this.$_View[0].innerHTML = template;

                    this.fixLink();
                }
            } else
                this.fixLink();

            return this.parseVM();
        },
        nodeOf:        function (data, exclude, forEach) {

            forEach = (forEach instanceof Function)  &amp;&amp;  forEach;

            var iMask = '0',  _This_ = this;

            for (var iName in data)
                if (this.__map__.hasOwnProperty( iName ))
                    iMask = $.bitOperate('|',  iMask,  this.__map__[ iName ]);

            return $.map(
                iMask.padStart(this.length, 0).split('').reverse(),
                function (bit, node) {

                    node = _This_[ node ];

                    if ((
                        (bit > 0)  ||  ((node || '').type > 1)
                    ) &amp;&amp; (
                        !(node instanceof RenderNode)  ||
                        (node.name !== 'value')  ||
                        (node.ownerElement !== exclude)
                    )) {
                        forEach  &amp;&amp;  forEach.call(_This_, node);

                        return node;
                    }
                }
            );
        },
        /**
         * 渲染视图
         *
         * @author   TechQuery
         *
         * @memberof HTMLView.prototype
         *
         * @param    {string|object} data    - Property Key or Data Object
         * @param    {*}             [value] - Property Value
         *
         * @returns  {HTMLView}      Current HTMLView
         */
        render:        function (data, value) {

            var _Data_ = { },  exclude;

            if (data instanceof Element) {

                exclude = data;

                data = exclude.getAttribute('name');

                value = HTMLView.getValue( exclude );
            }

            if (typeof data.valueOf() === 'string') {

                _Data_[data] = value;    data = _Data_;
            }

            _Data_ = this.__data__;

            this.nodeOf(_Data_.commit( data ),  exclude,  function (node) {

                if (node instanceof RenderNode)
                    node.render(this, _Data_);
                else if (node instanceof View) {

                    node.render(_Data_[node.__name__]);

                    _Data_[node.__name__] = node.__data__;
                }
            });

            return this;
        }
    }).registerEvent('template');

//  Render data from user input

    function reRender() {

        var iView = HTMLView.instanceOf( this );

        if (iView  &amp;&amp;  $( this ).validate())  iView.render( this );
    }

    $('html').on('change', ':field', reRender).on(
        'input',  ':field',  $.throttle( reRender )
    ).on('reset',  'form',  function () {

        var data = $.paramJSON('?'  +  $( this ).serialize());

        for (var key in data)  data[ key ] = '';

        HTMLView.instanceOf( this ).render( data );
    });

    return HTMLView;

});
</code></pre>
        </article>
    </section>

</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
