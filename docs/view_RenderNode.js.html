<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>view/RenderNode.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DataScope.html">DataScope</a></li><li><a href="HTMLView.html">HTMLView</a><ul class='methods'><li data-type='method'><a href="HTMLView.html#attach">attach</a></li><li data-type='method'><a href="HTMLView.html#childOf">childOf</a></li><li data-type='method'><a href="HTMLView.html#detach">detach</a></li><li data-type='method'><a href="HTMLView.html#emit">emit</a></li><li data-type='method'><a href="HTMLView.html#off">off</a></li><li data-type='method'><a href="HTMLView.html#on">on</a></li><li data-type='method'><a href="HTMLView.html#one">one</a></li><li data-type='method'><a href="HTMLView.html#parse">parse</a></li><li data-type='method'><a href="HTMLView.html#render">render</a></li><li data-type='method'><a href="HTMLView.html#scan">scan</a></li><li data-type='method'><a href="HTMLView.html#valueOf">valueOf</a></li><li data-type='method'><a href="HTMLView.html#watch">watch</a></li></ul></li><li><a href="InnerLink.html">InnerLink</a><ul class='methods'><li data-type='method'><a href="InnerLink.html#emit">emit</a></li><li data-type='method'><a href="InnerLink.html#off">off</a></li><li data-type='method'><a href="InnerLink.html#on">on</a></li><li data-type='method'><a href="InnerLink.html#one">one</a></li><li data-type='method'><a href="InnerLink.html#toString">toString</a></li><li data-type='method'><a href="InnerLink.html#valueOf">valueOf</a></li></ul></li><li><a href="ListView.html">ListView</a><ul class='methods'><li data-type='method'><a href="ListView.html#attach">attach</a></li><li data-type='method'><a href="ListView.html#childOf">childOf</a></li><li data-type='method'><a href="ListView.html#clear">clear</a></li><li data-type='method'><a href="ListView.html#detach">detach</a></li><li data-type='method'><a href="ListView.html#emit">emit</a></li><li data-type='method'><a href="ListView.html#indexOf">indexOf</a></li><li data-type='method'><a href="ListView.html#insert">insert</a></li><li data-type='method'><a href="ListView.html#off">off</a></li><li data-type='method'><a href="ListView.html#on">on</a></li><li data-type='method'><a href="ListView.html#one">one</a></li><li data-type='method'><a href="ListView.html#remove">remove</a></li><li data-type='method'><a href="ListView.html#render">render</a></li><li data-type='method'><a href="ListView.html#scan">scan</a></li><li data-type='method'><a href="ListView.html#sort">sort</a></li><li data-type='method'><a href="ListView.html#update">update</a></li><li data-type='method'><a href="ListView.html#valueOf">valueOf</a></li><li data-type='method'><a href="ListView.html#watch">watch</a></li></ul></li><li><a href="Observer.html">Observer</a><ul class='methods'><li data-type='method'><a href="Observer.html#.extend">extend</a></li><li data-type='method'><a href="Observer.html#.instanceOf">instanceOf</a></li><li data-type='method'><a href="Observer.html#.registerEvent">registerEvent</a></li><li data-type='method'><a href="Observer.html#emit">emit</a></li><li data-type='method'><a href="Observer.html#off">off</a></li><li data-type='method'><a href="Observer.html#on">on</a></li><li data-type='method'><a href="Observer.html#one">one</a></li><li data-type='method'><a href="Observer.html#valueOf">valueOf</a></li></ul></li><li><a href="RenderNode.html">RenderNode</a><ul class='methods'><li data-type='method'><a href="RenderNode.html#toString">toString</a></li></ul></li><li><a href="TreeView.html">TreeView</a><ul class='methods'><li data-type='method'><a href="TreeView.html#.fromFlat">fromFlat</a></li><li data-type='method'><a href="TreeView.html#attach">attach</a></li><li data-type='method'><a href="TreeView.html#childOf">childOf</a></li><li data-type='method'><a href="TreeView.html#clear">clear</a></li><li data-type='method'><a href="TreeView.html#detach">detach</a></li><li data-type='method'><a href="TreeView.html#emit">emit</a></li><li data-type='method'><a href="TreeView.html#indexOf">indexOf</a></li><li data-type='method'><a href="TreeView.html#insert">insert</a></li><li data-type='method'><a href="TreeView.html#off">off</a></li><li data-type='method'><a href="TreeView.html#on">on</a></li><li data-type='method'><a href="TreeView.html#one">one</a></li><li data-type='method'><a href="TreeView.html#remove">remove</a></li><li data-type='method'><a href="TreeView.html#render">render</a></li><li data-type='method'><a href="TreeView.html#scan">scan</a></li><li data-type='method'><a href="TreeView.html#sort">sort</a></li><li data-type='method'><a href="TreeView.html#update">update</a></li><li data-type='method'><a href="TreeView.html#valueOf">valueOf</a></li><li data-type='method'><a href="TreeView.html#watch">watch</a></li></ul></li><li><a href="View.html">View</a><ul class='methods'><li data-type='method'><a href="View.html#.extend">extend</a></li><li data-type='method'><a href="View.html#attach">attach</a></li><li data-type='method'><a href="View.html#childOf">childOf</a></li><li data-type='method'><a href="View.html#detach">detach</a></li><li data-type='method'><a href="View.html#emit">emit</a></li><li data-type='method'><a href="View.html#off">off</a></li><li data-type='method'><a href="View.html#on">on</a></li><li data-type='method'><a href="View.html#one">one</a></li><li data-type='method'><a href="View.html#scan">scan</a></li><li data-type='method'><a href="View.html#valueOf">valueOf</a></li><li data-type='method'><a href="View.html#watch">watch</a></li></ul></li><li><a href="WebApp.html">WebApp</a><ul class='methods'><li data-type='method'><a href="WebApp.html#.component">component</a></li><li data-type='method'><a href="WebApp.html#emit">emit</a></li><li data-type='method'><a href="WebApp.html#getRoute">getRoute</a></li><li data-type='method'><a href="WebApp.html#load">load</a></li><li data-type='method'><a href="WebApp.html#loadPage">loadPage</a></li><li data-type='method'><a href="WebApp.html#off">off</a></li><li data-type='method'><a href="WebApp.html#on">on</a></li><li data-type='method'><a href="WebApp.html#one">one</a></li><li data-type='method'><a href="WebApp.html#setURLData">setURLData</a></li><li data-type='method'><a href="WebApp.html#valueOf">valueOf</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-WebApp.html">WebApp</a></li></ul><h3>Externals</h3><ul><li><a href="external-_jQuery.fn_.html">jQuery.fn</a><ul class='methods'><li data-type='method'><a href="external-_jQuery.fn_.html#.iWebApp">iWebApp</a></li><li data-type='method'><a href="external-_jQuery.fn_.html#.view">view</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="HTMLView.html#event:attach">attach</a></li><li><a href="HTMLView.html#event:update">update</a></li><li><a href="ListView.html#event:attach">attach</a></li><li><a href="ListView.html#event:update">update</a></li><li><a href="TreeView.html#event:attach">attach</a></li><li><a href="TreeView.html#event:update">update</a></li><li><a href="View.html#event:attach">attach</a></li><li><a href="View.html#event:update">update</a></li><li><a href="WebApp.html#event:data">data</a></li><li><a href="WebApp.html#event:prefetch">prefetch</a></li><li><a href="WebApp.html#event:ready">ready</a></li><li><a href="WebApp.html#event:request">request</a></li><li><a href="WebApp.html#event:route">route</a></li><li><a href="WebApp.html#event:template">template</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#require">require</a></li></ul>
</nav>

<div id="main">

    <h1 class="page-title">view/RenderNode.js</h1>

    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define(['jquery', 'jQueryKit'],  function ($) {

    /**
     * 渲染节点
     *
     * @author TechQuery
     *
     * @class  RenderNode
     *
     * @param  {Node} node - A Node within a template
     */

    function RenderNode(node) {

        $.extend(this, {
            ownerNode:       node,
            raw:             node.nodeValue || node.value,
            ownerElement:    node.parentNode || node.ownerElement,
            type:            0,
            value:           null
        }).update();

        this.scan();
    }

    RenderNode.expression = /\$\{([\s\S]+?)\}/g;

    RenderNode.reference = /(\w+)(\.|\[(?:'|")|\()(\w+)?/g;

    RenderNode.rawName = /^(data\-|on)\w+/;

    RenderNode.Reference_Mask = {
        view:     1,
        this:     4,
        scope:    8
    };

    RenderNode.Template_Type = $.makeSet('Attr', 'Text', 'Comment');

    function Eval(view, scope, expression) {  'use strict';
        try {
            var iValue = eval( expression );

            return  (iValue != null)  ?  iValue  :  '';

        } catch (iError) {

            console.error( iError );

            return '';
        }
    }

    $.extend(RenderNode.prototype = [ ],  {
        constructor:    RenderNode,
        update:         function () {

            var node = this.ownerNode;

            if (! node)  return;

            var name = node.name;

            this.DOMType = $.Type( node );

            if (this.DOMType !== 'Attr')  return;

            var propKey = $.propFix[ name ]  ||  (
                    (name in node.ownerElement)  &amp;&amp;  name
                );

            if ( propKey )
                this.name = propKey,  this.DOMType = 'Prop';
            else
                this.name = name;
        },
        add:            function (key) {

            if (key  &amp;&amp;  (this.indexOf( key )  &lt;  0))
                this.push( key );
        },
        clear:          function () {

            var node = this.ownerNode,
                value = this.raw.replace(RenderNode.expression, '');

            switch ( this.DOMType ) {
                case 'Text':       ;
                case 'Comment':    return  (node.nodeValue = value);
                case 'Attr':       ;
                case 'Prop':
                    if (! (
                        (node.value = value)  ||
                        node.name.match( RenderNode.rawName )
                    )) {
                        this.ownerElement.removeAttribute( node.name );

                        this.ownerNode = null;
                    }
            }
        },
        scan:           function () {

            var _This_ = this;

            this.splice(0, Infinity);    this.type = 0;

            this.raw = this.raw.replace(
                RenderNode.expression,  function (_, expression) {

                    if (/\w+\s*\([\s\S]*?\)/.test( expression ))
                        _This_.type = _This_.type | 2;

                    expression.replace(
                        RenderNode.reference,  function (_, scope, symbol, key) {

                            var global = self[ scope ];

                            if ( global )
                                return  _This_.type = _This_.type | 16;

                            if (symbol[0] === '(')  return;

                            _This_.type = _This_.type |
                                RenderNode.Reference_Mask[ scope ];

                            if (scope !== 'this')  _This_.add( key );
                        }
                    );

                    return  '${' + expression.trim() + '}';
                }
            );

            if ( this[0] )  this.clear();
        },
        eval:           function (context, scope) {

            if (this.value === null)  this.update();

            var refer,  _This_ = this.ownerElement;

            var text = this.raw.replace(
                    RenderNode.expression,
                    function (template, expression, _, raw) {

                        refer = Eval.call(_This_, context, scope, expression);

                        return  (template == raw)  ?  raw  :  refer;
                    }
                );

            return  (this.raw == text)  ?  refer  :  text;
        },
        render:         function (context, scope) {

            var value = this.eval(context, scope),
                node = this.ownerNode,
                parent = this.ownerElement;

            if (value === this.value)  return;

            this.value = value;

            switch ( this.DOMType ) {
                case 'Text':    {
                    if (node.previousSibling || node.nextSibling)
                        node.nodeValue = value;
                    else
                        parent.innerHTML = value;

                    break;
                }
                case 'Prop':    if (this.name !== 'style') {

                    parent[ this.name ] = (value instanceof Function)  ?
                        value.bind( context )  :  value;

                    break;
                }
                case 'Attr':
                    if ( node )
                        node.value = value;
                    else
                        parent.setAttribute(this.name, value);
            }
        },
        /**
         * 生成文本值
         *
         * @author   TechQuery
         *
         * @memberof RenderNode.prototype
         *
         * @returns  {string} Text Value of this template
         */
        toString:       function () {

            return  this.value + '';
        }
    });

    return RenderNode;

});
</code></pre>
        </article>
    </section>

</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
