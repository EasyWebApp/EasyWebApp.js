!function(t){"function"==typeof define&&define.amd?define("EasyWebApp",["jquery","jQueryKit"],t):"object"==typeof module?module.exports=t(require("jquery"),require("jQueryKit")):this.EasyWebApp=t(this.jquery,this.jQueryKit)}(function(jquery,jQueryKit){var RenderNode=function($){function RenderNode(t){this.ownerNode=t,this.name=t.nodeName,this.raw=t.nodeValue,this.ownerElement=t.parentNode||t.ownerElement,this.hasScope=!1}function Eval(vm,iValue){"use strict";try{return null!=(iValue=$.isNumeric(iValue)?Number.isSafeInteger(+iValue)?+iValue:iValue:eval(iValue))?iValue:""}catch(t){return""}}return $.extend(RenderNode,{safeEval:function(t){switch(typeof t){case"function":return t.bind(this);case"string":if("0"!==t[0]&&t[1])return t}return t&&Eval("",t)||t},expression:/\$\{([\s\S]+?)\}/g,reference:/(this|vm)\.(\w+)/g}),$.extend(RenderNode.prototype,{eval:function(t,e){var i,n=this.raw.replace(RenderNode.expression,function(){return i=Eval.call(t,e,arguments[1]),arguments[0]==arguments[3]?arguments[3]:i});return this.raw==n?i:n},getRefer:function(){var t=this,e={};return this.ownerNode.nodeValue=this.raw.replace(RenderNode.expression,function(){return arguments[1].replace(RenderNode.reference,function(){"vm"==arguments[1]&&(t.hasScope=!0),e[arguments[2]]=1}),""}),Object.keys(e)},render:function(t,e){var i=this.eval(t,e),n=this.ownerNode,r=this.ownerElement;switch(n.nodeType){case 3:if(!n.previousSibling&&!n.nextSibling)return r.innerHTML=i;break;case 2:if("style"!=this.name&&this.name in r)return void(r[this.name]=RenderNode.safeEval.call(t,i));if(!n.ownerElement)return void(i&&r.setAttribute(this.name,i))}return n.nodeValue=i,this}}),RenderNode}(jquery),Observer=function(t){function Observer(e){this.$_View=e instanceof t?e:t(e);var i=this.$_View.data("[object Observer]");return null!=i&&i!=this?i:(this.$_View.data("[object Observer]",this),this.__handle__={},this)}return t.extend(Observer,{getEvent:function(e){return t.extend({},"string"==typeof e?{type:e}:e,arguments[1])},match:function(e,i){var n;for(var r in i)switch(n=e[r]instanceof RegExp,t.Type(i[r])){case"RegExp":if(n){if(e[r].toString()!=i[r].toString())return;break}case"String":if(!(e[r]||"")[n?"test":"match"](i[r]))return;break;case"Function":if("function"!=typeof e[r])break;default:if(e[r]!==i[r])return}return i},getClass:function(){return this.prototype.toString.call({constructor:this}).split(" ")[1].slice(0,-1)}}),t.extend(Observer.prototype,{toString:function(){return"[object "+this.constructor.name+"]"},destructor:function(){return this.$_View.data("[object Observer]",null),{$_View:this.$_View,__handle__:this.__handle__}},valueOf:function(e,i){return e?i?t.map(this.__handle__[e],function(){return arguments[0][i]}):this.__handle__[e]:this.__handle__},on:function(e,i){e=Observer.getEvent(e,{handler:i});for(var n=this.__handle__[e.type]=this.__handle__[e.type]||[],r=0;n[r];r++)if(t.isEqual(n[r],e))return this;return n.push(e),this},emit:function(t,e){return t=Observer.getEvent(t),(this.__handle__[t.type]||[]).reduce(function(e,i){if(!Observer.match(t,i))return e;var n=i.handler.call(this,t,e);return null!=n?n:e}.bind(this),e)},off:function(e,i){return e=Observer.getEvent(e,{handler:i}),this.__handle__[e.type]=t.map(this.__handle__[e.type],function(t){return Observer.match(e,t)?null:t}),this},one:function(){var e=this,i=t.makeArray(arguments),n=i.slice(-1)[0];n="function"==typeof n&&i.pop();var r=new Promise(function(t){e.on.apply(e,i.concat(function(){if(e.off.apply(e,i.concat(arguments.callee)),n)return n.apply(this,arguments);t(arguments[1])}))});return n?this:r}}),Observer}(jquery),DataScope=function(t){function DataScope(t){this.__data__=Object.create(t||{}),this.__data__.splice=this.__data__.splice||Array.prototype.splice}return t.extend(DataScope.prototype,{commit:function(e){var i={};t.likeArray(e)&&(i=[],this.__data__.splice(0,1/0));for(var n in e)!e.hasOwnProperty(n)||null==e[n]||"object"!=typeof e[n]&&this.__data__.hasOwnProperty(n)&&e[n]==this.__data__[n]||(i[n]=this.__data__[n]=e[n]);return i},watch:function(t,e){t in this||Object.defineProperty(this,t,{get:function(){return this.__data__[t]},set:e.bind(this,t)})},valueOf:function(){var e=this.__data__.hasOwnProperty("length")?Array.apply(null,this.__data__):{};for(var i in this.__data__)this.__data__.hasOwnProperty(i)&&!t.isNumeric(i)&&(e[i]=this[i]);return e},clear:function(){var e=this.__data__;e.hasOwnProperty("length")&&e.splice(0,1/0);for(var i in e)e.hasOwnProperty(i)&&(t.likeArray(e[i])?e.splice.call(e[i],0,1/0):e[i]="");return this}}),DataScope}(jquery),View=function(t,e,i,n){function View(n,r){if(this.constructor==arguments.callee)throw TypeError("View() is an Abstract Base Class which can't be instantiated.");var a=e.call(this,n);return i.call(t.extend(this,a.destructor()),r),null!=(a=this.constructor.instanceOf(this.$_View,!1))&&a!=this?a:t.extend(this,{__name__:this.$_View[0].name||this.$_View[0].dataset.name,__child__:[]}).attach()}return t.extend(View.prototype,i.prototype),t.inherit(e,View,{signSelector:function(){var e=this;return t.expr[":"][this.getClass().toLowerCase()]=function(){return(t.data(arguments[0],"[object View]")||"")instanceof e},this},Sub_Class:[],getSub:function(t){for(var e=this.Sub_Class.length-1;this.Sub_Class[e];e--)if(this.Sub_Class[e].is(t))return new this.Sub_Class[e](t,(this.instanceOf(t.parentNode)||"").__data__)},extend:function(e,i,n){return this.Sub_Class.push(e),t.inherit(this,e,i,n).signSelector()},instanceOf:function(e,i){var n;e=t(e);do{if((n=e.data("[object View]"))instanceof this)return n;e=e.parent()}while(e[0]&&!1!==i)},getObserver:function(t){return this.instanceOf(t,!1)||new e(t)},setEvent:function(i){return t.each(i.attributes,function(){var t=(this.nodeName.match(/^on(\w+)/i)||"")[1];!t||this.nodeName in i||Object.defineProperty(i,"on"+t,{set:function(e){var n=View.getObserver(i);n.off(t),"function"==typeof e&&n.on(t,e)},get:function(){return e.prototype.valueOf.call(View.getObserver(i),t,"handler")[0]}})}),i}},{attrWatch:function(){var e=this;this.__observer__=new self.MutationObserver(function(){var i={};t.each(arguments[0],function(){var e=this.target.getAttribute(this.attributeName);e==this.oldValue||(this.oldValue||"").match(n.expression)||(i[t.camelCase(this.attributeName.slice(5))]=e)}),t.isEmptyObject(i)||e.render(i).emit({type:"update",target:e.$_View[0]},i)}),this.__observer__.observe(this.$_View[0],{attributes:!0,attributeOldValue:!0,attributeFilter:t.map(Object.keys(this.$_View[0].dataset),function(){return"data-"+t.hyphenCase(arguments[0])})})},attach:function(){return this.$_View[0].id||(this.$_View[0].id=this.__id__||t.uuid("View")),this.__id__=this.$_View[0].id,this.$_View.data("[object View]",this),this.$_View[0].dataset.href&&this.attrWatch(),this.emit({type:"attach",target:this.$_View.append(this.$_Content)[0]}),this},detach:function(){return this.$_View[0].id.match(/^View_\w+/)&&(this.$_View[0].id=""),this.$_View.data("[object View]",null),this.__observer__&&(this.__observer__.disconnect(),delete this.__observer__),this.$_Content=this.$_View.children().detach(),this},filter:function(t,e){var i;return e.dataset.href?(this.__child__.push(e),NodeFilter.FILTER_REJECT):e.dataset.name||(i=View.instanceOf(e,!1))?(t.push(i||View.getSub(e)),NodeFilter.FILTER_REJECT):e.parentNode==document.head&&"title"!=e.tagName.toLowerCase()?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},scan:function(e){var i=[],n={acceptNode:this.filter.bind(this,i)},r=document.createTreeWalker(this.$_View[0],1,t.browser.msie<12?n.acceptNode:n,!0);e.call(this,this.$_View[0]);for(var a,s,o;a=a||r.nextNode();)(s=e.call(this,a))!=a?(t(s).insertTo(a.parentNode,t(a).index()+1),o=a,a=r.nextNode(),t(o).remove()):a=null;for(h=0;this.__child__[h];h++)e.call(this,View.setEvent(this.__child__[h]));for(var h=0;i[h];h++)e.call(this,i[h])},childOf:function(t){return t?View.instanceOf(this.$_View.find(t+"[data-href]")):this.__child__}}).signSelector()}(jquery,Observer,DataScope,RenderNode),InnerLink=function(t,e){function InnerLink(t){var i=e.call(this,t);i!=this&&(this.__handle__=i.__handle__),this.method=(t.getAttribute("method")||t.dataset.method||"Get").toUpperCase(),this.contentType=t.getAttribute("type")||t.getAttribute("enctype")||"application/x-www-form-urlencoded",this.charset=(t.getAttribute("charset")||t.acceptCharset||document.charset).split(/\s+/),this.setURI().title=t.title||document.title,/^(a|area|form)$/i.test(t.tagName)?this.href?this.target="page":this.target="data":this.target="view"}return t.inherit(e,InnerLink,{parsePath:function(t){var e;t=t.replace(/^\.\//,"").replace(/\/\.\//g,"/");do{e=(t=e||t).replace(/[^\/]+\/\.\.\//g,"")}while(e!=t);return e},HTML_Link:"a[href], area[href], form[action]",Self_Link:"[data-href]:not(a, form)"},{setURI:function(){var e=this.$_View[0];return this.href=e.dataset.href||e.getAttribute(e.href?"href":"action"),this.src=this.href.split(/\?data=|&data=/),this.href=this.src[0],this.src=this.src[1],this.data=t.paramJSON(this.href),this.href=InnerLink.parsePath(this.href.split("?")[0]),this},getURI:function(){var e=[t.param(this.data)];return e[0]||(e.length=0),this.src&&e.push("data="+this.src),e=e.join("&"),(this.href||"")+(e&&"?"+e)},loadData:function(){var e=this.method+" ",i={type:this.method,beforeSend:arguments[0],contentType:this.contentType+"; charset="+this.charset[0],dataType:(this.src.match(/\?/g)||"")[1]?"jsonp":"json",complete:function(){e+=this.url}};this.$_View[0].tagName.match(/^(a|area)$/i)?(i.data=t.extend({},this.$_View[0].dataset),delete i.data.method,delete i.data.autofocus):this.$_View.find('input[type="file"]')[0]?"GET"!=i.type&&(i.data=new self.FormData(this.$_View[0]),i.contentType=i.processData=!1):i.data=t.paramJSON("?"+this.$_View.serialize()),this.contentType.match(/^application\/json/)&&(i.data=JSON.stringify(i.data),i.processData=!1);var n=Promise.resolve(t.ajax(this.src,i));return"GET"!=this.method?n:n.then(function(){return t.storage(e,arguments[0])},function(){return t.storage(e)})},load:function(e){return Promise.all([this.href&&t.ajax({type:"GET",url:this.href,beforeSend:e}),this.src&&this.loadData(e)])},valueOf:function(){var t={};for(var e in this)"object"!=typeof this[e]&&"function"!=typeof this[e]&&(t[e]=this[e]);return t.target=this.$_View[0],t}})}(jquery,Observer),DOMkit=function(t,e,i){var n=t.makeSet("a","area","form");return{fixScript:function(e){var i={};return t.each(e.attributes,function(){i[this.nodeName]=this.nodeValue}),e=t("<script />",i)[0]},fixLink:function(e){"_self"==(e.target||"_self")&&t.urlDomain(e.href||e.action)!=t.urlDomain()&&(e.target="_blank")},fixURL:function(n,r,a){var s=n.getAttribute(r)||"";return"#"===s[0]||(s.match(e.expression)||[]).join("")==s?s:(s=s.split("?"),a&&s[0]&&!t.urlDomain(s[0])&&s[0].indexOf(a)<0&&(s[0]=i.parsePath(a+s[0]),n.setAttribute(r,s.join("?"))),s.join("?"))},prefetch:function(i,r){i.tagName.toLowerCase()in n&&"_self"==(i.target||"_self")&&!r.match(e.expression)&&!t('head link[href="'+r+'"]')[0]&&t("<link />",{rel:t.browser.msie<11||t.browser.ios?"next":"prefetch",href:r}).appendTo(document.head)}}}(jquery,RenderNode,InnerLink),HTMLView=function(t,e,i,n){function HTMLView(i,n){var r=e.call(this,i,n);if(this!=r)return r;t.extend(this,{length:0,__map__:{}}).on("attach",function(){this.$_View.find('style, link[rel="stylesheet"]').each(function(){e.instanceOf(this).fixStyle(this)})})}return e.extend(HTMLView,{is:function(){return!0},rawSelector:t.makeSet("code","xmp","template")},{parseSlot:function(t){t=t.getAttribute("name");var e=this.$_Content.filter(t?'[slot="'+t+'"]':'[slot=""], :not([slot])');return this.$_Content=this.$_Content.not(e),e},fixStyle:function(e){var i=e.tagName.toLowerCase();if("link"==i&&!e.sheet)return e.onload=arguments.callee.bind(this,e);for(var n=t.map(e.sheet.cssRules,function(t){switch(t.type){case 1:return t;case 4:return Array.apply(null,t.cssRules)}}),r=0;n[r];r++)n[r].selectorText.indexOf("#")<0&&(n[r].selectorText="#"+this.__id__+" "+n[r].selectorText);"style"==i&&(e.disabled=!1)},fixDOM:function(t){var e="src";switch(t.tagName.toLowerCase()){case"link":if("rel"in t&&"stylesheet"!=t.rel)return t;e="href";case"style":this.fixStyle(t);break;case"script":t=i.fixScript(t);break;case"img":case"iframe":case"audio":case"video":break;case"a":case"area":case"form":e="href"in t?"href":"action",i.fixLink(t);break;default:e="data-href"}return i.prefetch(t,i.fixURL(t,e,this.__base__)),t},signIn:function(t,e){for(var i=0;this[i];i++)if(this[i]==t)return;this[this.length++]=t;for(var n=0;e[n];n++)this.__map__[e[n]]=(this.__map__[e[n]]||0)+Math.pow(2,i)},parsePlain:function(e){var i=this;t.each(Array.prototype.concat.apply(t.makeArray(e.attributes),e.childNodes),function(){if(this.nodeValue&&(2==this.nodeType||3==this.nodeType)){var e=new n(this),r=e.getRefer();r[0]&&(i.signIn(e,r),!this.nodeValue&&2==this.nodeType&&(t.propFix[this.nodeName]||this.nodeName)in this.ownerElement&&this.ownerElement.removeAttribute(this.nodeName))}})},parse:function(i,n){return this.__base__=i,n&&(this.$_Content=this.$_View.children().detach(),this.$_View[0].innerHTML=n),this.scan(function(i){if(i instanceof Element){if("slot"==i.tagName.toLowerCase())return t.map(this.parseSlot(i),arguments.callee.bind(this));i!=this.$_View[0]&&i.outerHTML!=this.lastParsed&&(i=this.fixDOM(i),this.lastParsed=i.outerHTML)}switch(!0){case i instanceof e:this.signIn(i,[i.__name__]);break;case t.expr[":"].field(i)&&"file"!=i.type&&!i.defaultValue:this.signIn(i,[i.name]);case!(i.tagName.toLowerCase()in HTMLView.rawSelector):this.parsePlain(i)}return i}),delete this.$_Content,this},getNode:function(){var e="0",i=this;for(var n in arguments[0])this.__map__.hasOwnProperty(n)&&(e=t.bitOperate("|",e,this.__map__[n]));return t.map(e.split("").reverse(),function(t,e){if(t>0||(i[e]||"").hasScope)return i[e]})},render:function(i){var r=this,a={};"string"==typeof i.valueOf()&&(a[i]=arguments[1],i=a),i=this.commit(i),a=this.__data__;for(var s in i)this.watch(s,arguments.callee);return i&&t.each(this.getNode(i),function(){this instanceof n?this.render(r,a):this instanceof e?this.render(a[this.__name__]):t(this)["value"in this?"val":"html"](a[this.name||this.getAttribute("name")])}),this}})}(jquery,View,DOMkit,RenderNode),ListView=function(t,e,i){return e.extend(function(){var t=e.apply(this,arguments);if(this!=t)return t;this.__HTML__=this.$_View.html(),this.clear()},{is:t.expr[":"].list},{splice:Array.prototype.splice,clear:function(){return this.$_View.empty(),this.splice(0,1/0),this},insert:function(t,e,n){var r=new i(this.__HTML__,this.__data__).parse();return n||r.$_View.insertTo(this.$_View,e),t.__index__=e||0,this.splice(t.__index__,0,r.render(t)),r},render:function(e){return t.likeArray(e)&&t(Array.prototype.map.call(e,function(){return this.insert.apply(this,arguments).$_View[0]},this)).insertTo(this.$_View,this.length),this},indexOf:function(e){return((e=e instanceof t?e:t(e))[0].parentNode==this.$_View[0]?e:e.parentsUntil(this.$_View)).slice(-1).index()},remove:function(e){var i=this.splice(t.isNumeric(e)?e:this.indexOf(e),1)[0];return i.$_View.remove(),i},sort:function(){return Array.prototype.sort.call(this,arguments[0]),this.$_View.append(t.map(this,function(t){return t.__index__=arguments[1],t.$_View[0]})),this},childOf:function(){return t.map(this,function(){return arguments[0].__child__})},valueOf:function(){return t.map(this,function(){return arguments[0].valueOf()})}})}(jquery,View,HTMLView),WebApp=function(t,e,i,n,r,a){return t.inherit(e,function(i,n){if(this instanceof t)return new arguments.callee(this[0],i,n);var r=t('*:data("_EWA_")').data("_EWA_")||this;if(null!=r&&r!=this)return r;e.call(this,i).destructor().$_View.data("_EWA_",this),this.apiRoot=n||"";var a=self.location.href.split("?")[0];this.pageRoot=t.filePath(a+(a.match(/\/([^\.]+\.html?)?/i)?"":"/"))+"/",this.length=0,this.lastPage=-1,this.loading={},self.setTimeout(this.listenDOM().listenBOM().boot.bind(this))},{View:i,HTMLView:n,ListView:r},{splice:Array.prototype.splice,switchTo:function(t){if(this.lastPage!=t){var e=i.instanceOf(this.$_View,!1);return e&&e.detach(),this.lastPage>-1&&(this[this.lastPage].view=e),(e=(this[t]||"").view)&&e.attach()}},setRoute:function(t){this.switchTo();var e=this[this.lastPage],i=t.getURI();e&&e.getURI()==i||(++this.lastPage!=this.length&&this.splice(this.lastPage,1/0),self.history.pushState({index:this.length},document.title=t.title,"#!"+self.btoa(i)),this[this.length++]=t)},getRoute:function(){return self.atob((self.location.hash.match(/^\#!(.+)/)||"")[1]||"")},getCID:function(){return arguments[0].replace(this.pageRoot,"").replace(/\.\w+(\?.*)?/i,".html")},_emit:function(e,i,n){return this.emit(t.extend(i.valueOf(),{type:e,target:"page"==i.target?this.$_View[0]:void 0}),n)},loadView:function(e,n){var r=e.$_View;"page"==e.target&&(this.setRoute(e),r=this.$_View),n=this._emit("template",e,n);var a=i.getSub(r[0]);return r.children()[0]||(r[0].innerHTML=n,n=""),a.parse&&a.parse(e.href?t.filePath(e.href)+"/":(a.$_View.parents(":view").view()||"").__base__,n),r.find("script[src]:not(head > *)")[0]||e.emit("load"),a},loadComponent:function(e,i,n){this.loading[e.href]=e;var r=e.one("load"),a=this.loadView(e,i),s=this;return r.then(function(i){delete s.loading[e.href];var r=n instanceof Array?[]:{};n=t.extend(r,e.data,e.$_View[0].dataset,n),i&&(n=t.extend(r,n,i.call(a,n))),a.render(n)}).then(function(){return Promise.all(t.map(a.childOf(),s.load.bind(s)))}).then(function(){return a})},load:function(e){e instanceof Element&&(e=new a(e));var n=this;return e.load(function(){"json"!=(this.dataType||"").slice(0,4)||t.urlDomain(this.url)||(this.url=n.apiRoot+this.url),n.emit(t.extend(e.valueOf(),{type:"request"}),{option:this,transport:arguments[0]}),this.crossDomain=t.isCrossDomain(this.url)}).then(function(){var t=arguments[0][0],i=arguments[0][1];if(null!=i&&(i=n._emit("data",e,i)),"data"!=e.target)return n.loadComponent(e,t,i)}).then(function(t){t instanceof i&&n._emit("ready",e,t)})},listenDOM:function(){var e=this;return t("html").on("input change",":field",t.throttle(function(){var t=n.instanceOf(this);t&&t.render(this.name||this.getAttribute("name"),"value"in this?this.value:this.innerHTML)})).on("click submit",a.HTML_Link,function(t){"FORM"==this.tagName&&"submit"!=t.type||"_self"!=(this.target||"_self")||0===((this.href||this.action).match(e.pageRoot)||"").index&&(t.preventDefault(),e.load(this))}),this},listenBOM:function(){var e=this;return t(self).on("popstate",function(){var t=(arguments[0].originalEvent.state||"").index;e[t]&&e.lastPage!=t&&Promise.resolve(e.switchTo(t)||e.load(e[t])).then(function(){e.lastPage=t,document.title=e[t].title})}),this},boot:function(){var e=this;return Promise.all(t.map(t("[data-href]:not([data-href] *)").not(this.$_View.find("[data-href]")),function(){return e.load(arguments[0])})).then(function(){var i=e.getRoute();if(i)return e.load(t("<a />",{href:i})[0]);t('a[href][data-autofocus="true"]').eq(0).click()})}})}(jquery,Observer,View,HTMLView,ListView,InnerLink);return function(t,e){var i,n=self.require;return self.require=function(){if(!document.currentScript)return n.apply(this,arguments);var t=arguments,r=(new e).getCID(document.currentScript.src);n.call(this,t[0],function(){return i=r,t[1].apply(this,arguments)})},t.extend(e.fn=e.prototype,{component:function(t){return this.loading[i]&&this.loading[i].emit("load",t),this},loadPage:function(e){var i=this;return e?new Promise(function(){t(self).one("popstate",arguments[0])[0].history.go(e)}).then(function(){return i.load(i[i.lastPage])}):Promise.resolve("")}}),t.fn.view=function(t){if(this[0])return t?new e[t](this[0],arguments[1]):e.View.instanceOf(this[0],!1)},t.fn.iWebApp=e}(jquery,WebApp)});
//# sourceMappingURL=EasyWebApp.min.js.map